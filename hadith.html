<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>رمضان كريم | الأحاديث</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="رمضان كريم">
    <link rel="apple-touch-icon" href="images/icon-192.png">
    <link
        href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/share-utils.js?v=v_spa_fixed_v19"></script>
    <script src="js/main.js?v=v_spa_fixed_v19"></script>
    <script src="js/notifications.js?v=v_spa_fixed_v19"></script>
    <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css">
    <link rel="stylesheet" href="css/style.css?v=v_spa_fixed_v19">
</head>

<body class="bg-ramadan-dark text-white font-tajawal">
    <div id="nav-placeholder"></div>
    <div id="page-content-wrapper">
        <section id="hadith" class="py-24 min-h-screen relative overflow-hidden">
            <div class="absolute inset-0 stars opacity-30"></div>
            <div class="absolute inset-0 islamic-pattern opacity-10"></div>
            <div class="container mx-auto px-4 relative z-10">
                <div class="text-center mb-8">
                    <span class="text-ramadan-gold text-sm font-bold tracking-wider">سنة النبي ﷺ</span>
                    <h2 class="text-3xl lg:text-5xl font-bold mt-2 font-amiri text-white text-shadow">الأحاديث النبوية</h2>
                </div>

                <div class="flex flex-col lg:flex-row gap-6 max-w-7xl mx-auto">
                    <!-- Filters -->
                    <div class="lg:w-1/4 space-y-3">
                        <button onclick="loadCategory('bukhari')"
                            class="w-full p-4 rounded-xl glass-effect text-right hover:border-ramadan-gold border border-transparent transition-all flex items-center justify-between group active-category"
                            id="btn-bukhari">
                            <span class="font-bold">صحيح البخاري</span>
                            <i class="fas fa-book text-gray-500 group-hover:text-ramadan-gold transition-colors"></i>
                        </button>
                        <button onclick="loadCategory('muslim')"
                            class="w-full p-4 rounded-xl glass-effect text-right hover:border-ramadan-gold border border-transparent transition-all flex items-center justify-between group"
                            id="btn-muslim">
                            <span class="font-bold">صحيح مسلم</span>
                            <i class="fas fa-book-open text-gray-500 group-hover:text-ramadan-gold transition-colors"></i>
                        </button>

                        <div class="mt-8 glass-effect p-4 rounded-xl border border-white/5">
                            <label class="text-xs text-ramadan-gold/60 mb-2 block font-bold uppercase tracking-widest">البحث في المتن</label>
                            <div class="relative">
                                <input type="text" id="searchInput" placeholder="اكتب كلمة للبحث..."
                                    class="w-full p-3 pr-10 rounded-lg bg-ramadan-dark/80 border border-ramadan-gold/20 text-white text-sm focus:border-ramadan-gold outline-none transition-all">
                                <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                            </div>
                        </div>
                        
                        <div id="systemStatus" class="mt-4 p-3 rounded-lg bg-white/5 border border-white/5 text-[10px] text-gray-500 font-mono hidden">
                            <!-- Debug status info -->
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="lg:w-3/4 flex flex-col">
                         <div id="loadingOverlay" class="hidden flex flex-col items-center justify-center py-20 glass-effect rounded-2xl border border-ramadan-gold/10">
                            <div class="relative w-20 h-20 mb-6">
                                <div class="absolute inset-0 border-4 border-ramadan-gold/20 rounded-full"></div>
                                <div class="absolute inset-0 border-4 border-ramadan-gold border-t-transparent rounded-full animate-spin"></div>
                                <i class="fas fa-book-quran absolute inset-0 flex items-center justify-center text-ramadan-gold text-xl"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-2">جاري تحميل البيانات</h3>
                            <p id="loadingMsg" class="text-gray-400 text-sm animate-pulse">يتم الآن جلب الأحاديث من الخادم...</p>
                            <div class="mt-4 px-4 py-1 rounded-full bg-ramadan-gold/10 text-[10px] text-ramadan-gold border border-ramadan-gold/20" id="progressIndicator">
                                انتظر قليلاً...
                            </div>
                        </div>

                        <div id="hadithContainer" class="space-y-4 max-h-[75vh] overflow-y-auto pr-2 custom-scrollbar">
                            <!-- Hadiths will appear here -->
                        </div>

                        <!-- Empty State -->
                        <div id="emptyState" class="hidden text-center py-20 glass-effect rounded-2xl border border-white/5">
                            <i class="fas fa-info-circle text-gray-600 text-5xl mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-400">لا توجد أحاديث لعرضها</h3>
                            <p class="text-gray-500 mt-2">جرب تغيير التصنيف أو البحث بكلمة أخرى</p>
                        </div>

                        <!-- Pagination -->
                        <div class="mt-8 flex justify-between items-center bg-white/5 p-4 rounded-xl border border-white/5" id="paginationUI">
                            <button onclick="changePage(-1)"
                                class="flex items-center gap-2 px-5 py-2.5 rounded-lg bg-white/5 hover:bg-ramadan-gold hover:text-ramadan-dark active:scale-95 disabled:opacity-30 disabled:pointer-events-none transition-all font-bold"
                                id="prevBtn">
                                <i class="fas fa-chevron-right"></i>
                                <span>السابق</span>
                            </button>
                            <div class="text-center">
                                <span id="pageInfo" class="text-sm font-bold text-ramadan-gold">صفحة 1</span>
                                <div id="totalInfo" class="text-[10px] text-gray-500 uppercase tracking-tighter mt-0.5">0 حديث متوفر</div>
                            </div>
                            <button onclick="changePage(1)"
                                class="flex items-center gap-2 px-5 py-2.5 rounded-lg bg-white/5 hover:bg-ramadan-gold hover:text-ramadan-dark active:scale-95 disabled:opacity-30 disabled:pointer-events-none transition-all font-bold"
                                id="nextBtn">
                                <span>التالي</span>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <div id="footer-placeholder"></div>

    <script>
        // Global variables with persistent state for SPA
        var currentData = currentData || [];
        var filteredData = filteredData || [];
        var currentPage = currentPage || 1;
        var currentCollection = currentCollection || 'bukhari';
        var perPage = 20;
        var loadingInProgress = false;

        document.addEventListener("DOMContentLoaded", () => {
            initHadithPage();
        });

        // SPA logic
        (function() {
            if (window.hadithInitApplied) return;
            window.addEventListener('spaPageLoaded', () => {
                if (window.location.href.includes('hadith.html')) {
                    initHadithPage();
                }
            });
            window.hadithInitApplied = true;
        })();

        async function initHadithPage() {
            if (typeof injectNav === 'function') injectNav('hadith');
            if (typeof injectFooter === 'function') injectFooter();
            
            // Set up search listener
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = ''; // Reset search on fresh load
                searchInput.addEventListener('input', (e) => {
                    const val = (e.target.value || '').trim();
                    clearTimeout(window.hadithSearchDelay);
                    window.hadithSearchDelay = setTimeout(() => searchHadith(val), 400);
                });
            }

            // Initial load
            if (currentData.length === 0 || currentCollection !== 'bukhari') {
                await loadCategory('bukhari');
            } else {
                renderHadiths();
            }
        }

        function logStatus(msg) {
            const statusBox = document.getElementById('systemStatus');
            if (statusBox) {
                statusBox.classList.remove('hidden');
                statusBox.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
                statusBox.scrollTop = statusBox.scrollHeight;
            }
            console.log("Hadith System:", msg);
        }

        async function loadCategory(cat) {
            if (loadingInProgress) return;
            loadingInProgress = true;
            
            currentCollection = cat;
            currentPage = 1;
            
            if (typeof NProgress !== 'undefined') NProgress.start();
            
            const overlay = document.getElementById('loadingOverlay');
            const msg = document.getElementById('loadingMsg');
            const container = document.getElementById('hadithContainer');
            const progress = document.getElementById('progressIndicator');
            const empty = document.getElementById('emptyState');

            if (overlay) overlay.classList.remove('hidden');
            if (container) container.classList.add('hidden');
            if (empty) empty.classList.add('hidden');
            if (msg) msg.innerText = "جاري الاتصال بقاعدة البيانات...";
            
            // Highlight active button
            document.querySelectorAll('button[id^="btn-"]').forEach(b => {
                b.classList.remove('active-category', 'border-ramadan-gold', 'bg-ramadan-gold/10');
                b.querySelector('i').classList.add('text-gray-500');
                b.querySelector('i').classList.remove('text-ramadan-gold');
            });
            const activeBtn = document.getElementById(`btn-${cat}`);
            if (activeBtn) {
                activeBtn.classList.add('active-category', 'border-ramadan-gold', 'bg-ramadan-gold/10');
                activeBtn.querySelector('i').classList.remove('text-gray-500');
                activeBtn.querySelector('i').classList.add('text-ramadan-gold');
            }

            try {
                logStatus(`Starting load for ${cat}...`);
                const paths = [`./data/${cat}.json`, `data/${cat}.json`, `/data/${cat}.json`];
                let response = null;
                let usedPath = "";

                for (let path of paths) {
                    try {
                        logStatus(`Attempting path: ${path}`);
                        response = await fetch(path, { cache: 'default' });
                        if (response.ok) {
                            usedPath = path;
                            break;
                        }
                    } catch (err) {
                        logStatus(`Path ${path} error: ${err.message}`);
                    }
                }

                if (!response || !response.ok) {
                    logStatus("All standard paths failed, trying with cache buster...");
                    response = await fetch(`./data/${cat}.json?v=${Date.now()}`, { cache: 'no-store' });
                }

                if (!response || !response.ok) throw new Error("Could not reach hadith data files.");

                if (msg) msg.innerText = "وصلت البيانات، جاري فك التشفير (الجزء الأكبر)...";
                if (progress) progress.innerText = "جاري المعالجة... يرجى الانتظار";

                const json = await response.json();
                
                if (!json || !json.hadiths) throw new Error("Invalid structure in JSON file.");
                
                logStatus(`Loaded ${json.hadiths.length} hadiths from ${usedPath}`);
                
                currentData = json.hadiths;
                filteredData = currentData;
                
                renderHadiths();
                
                if (typeof NProgress !== 'undefined') NProgress.done();
            } catch (err) {
                logStatus(`CRITICAL ERROR: ${err.message}`);
                if (typeof NProgress !== 'undefined') NProgress.done();
                if (container) {
                    container.classList.remove('hidden');
                    container.innerHTML = `
                        <div class="text-center py-16 bg-red-500/5 rounded-2xl border border-red-500/20 glass-effect mt-4">
                            <i class="fas fa-cloud-bolt text-red-500 text-5xl mb-6"></i>
                            <h3 class="text-xl font-bold text-red-400 mb-2">فشلت عملية التحميل</h3>
                            <p class="text-gray-400 max-w-md mx-auto mb-8 px-4">قد يكون هناك مشكلة في اتصال الإنترنت أو الملفات غير متوفرة حالياً. حاول مسح الكاش وإعادة المحاولة.</p>
                            <div class="flex flex-wrap justify-center gap-4">
                                <button onclick="window.location.reload()" class="px-8 py-3 bg-white/5 hover:bg-white/10 rounded-full font-bold transition-all">تحميل الصفحة بالكامل</button>
                                <button onclick="loadCategory('${cat}')" class="px-8 py-3 bg-ramadan-gold text-ramadan-dark rounded-full font-bold shadow-lg shadow-ramadan-gold/20 active:scale-95 transition-all">إعادة المحاولة</button>
                            </div>
                        </div>`;
                }
            } finally {
                loadingInProgress = false;
                if (overlay) overlay.classList.add('hidden');
            }
        }

        function renderHadiths() {
            const container = document.getElementById('hadithContainer');
            const pagination = document.getElementById('paginationUI');
            const empty = document.getElementById('emptyState');
            
            if (!container) return;
            
            container.innerHTML = '';
            container.classList.remove('hidden');

            if (filteredData.length === 0) {
                if (empty) empty.classList.remove('hidden');
                if (pagination) pagination.classList.add('hidden');
                return;
            }

            if (empty) empty.classList.add('hidden');
            if (pagination) pagination.classList.remove('hidden');

            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const slice = filteredData.slice(start, end);

            slice.forEach((h, idx) => {
                const globalIdx = start + idx;
                const card = document.createElement('div');
                card.className = "glass-effect p-6 rounded-2xl border border-white/5 border-r-4 border-r-ramadan-gold relative group hover:border-ramadan-gold/30 transition-all duration-300 animate-slide-up shadow-lg shadow-black/20";
                card.style.animationDelay = `${idx * 50}ms`;
                
                const hNum = h.hadithnumber || h.hadith_number || 'N/A';

                card.innerHTML = `
                    <div class="text-lg font-amiri leading-relaxed text-gray-100 mb-6 px-1 text-justify whitespace-pre-line tracking-wide">
                        ${h.text}
                    </div>
                    
                    <div class="flex items-center justify-between border-t border-white/5 pt-5 mt-2">
                         <div class="flex items-center gap-3">
                            <button onclick="handleHadithShare(${globalIdx})"
                                    class="w-11 h-11 rounded-xl bg-white/5 hover:bg-ramadan-gold/20 text-gray-400 hover:text-ramadan-gold transition-all flex items-center justify-center group/btn"
                                    title="مشاركة عبر التطبيقات">
                                <i class="fas fa-share-nodes text-lg group-hover/btn:rotate-12 transition-transform"></i>
                            </button>
                            <button onclick="handleHadithBookmark(${globalIdx})" 
                                    class="w-11 h-11 rounded-xl bg-white/5 hover:bg-ramadan-gold/20 text-gray-400 hover:text-red-500 transition-all flex items-center justify-center group/btn"
                                    id="bm-hadith-${currentCollection}-${hNum}"
                                    title="حفظ في المفضلة">
                                <i class="${isHadithBookmarked(currentCollection, hNum) ? 'fas fa-heart text-red-500 scale-110' : 'far fa-heart'} text-lg group-hover/btn:scale-110 transition-transform"></i>
                            </button>
                         </div>

                        <div class="flex flex-col items-end gap-1">
                            <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-ramadan-gold/10 border border-ramadan-gold/20 text-ramadan-gold shadow-inner shadow-ramadan-gold/5">
                                <span class="text-[10px] opacity-70 font-bold uppercase tracking-widest">رقم الحديث</span>
                                <span class="font-bold font-mono text-sm">${hNum}</span>
                            </div>
                            <span class="text-[9px] text-gray-600 uppercase tracking-widest px-1 font-bold">المصدر: ${currentCollection === 'bukhari' ? 'البخاري' : 'مسلم'}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            updateHadithPaginationUI();
            container.scrollTop = 0;
        }

        function handleHadithShare(idx) {
            const h = filteredData[idx];
            if (!h) return;
            const hNum = h.hadithnumber || h.hadith_number || 'N/A';
            const collName = currentCollection === 'bukhari' ? 'صحيح البخاري' : 'صحيح مسلم';
            if (typeof showShareOptions === 'function') {
                showShareOptions(h.text, `${collName} - رقم الحديث: ${hNum}`);
            } else {
                navigator.clipboard.writeText(`${h.text}\n\n[المصدر: ${collName} - رقم: ${hNum}]`);
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'تم نسخ نص الحديث للهاتف', showConfirmButton: false, timer: 2000 });
            }
        }

        function handleHadithBookmark(idx) {
            const h = filteredData[idx];
            if (!h) return;
            const hNum = h.hadithnumber || h.hadith_number || 'N/A';
            toggleHadithBookmark(currentCollection, hNum, h.text);
        }

        function updateHadithPaginationUI() {
            const pi = document.getElementById('pageInfo');
            const ti = document.getElementById('totalInfo');
            const pb = document.getElementById('prevBtn');
            const nb = document.getElementById('nextBtn');
            
            const totalPages = Math.ceil(filteredData.length / perPage);
            const totalCount = filteredData.length;
            
            if (pi) pi.textContent = `الصفحة ${totalPages === 0 ? 0 : currentPage} من ${totalPages}`;
            if (ti) ti.textContent = `${totalCount.toLocaleString('ar-EG')} حديث متوفر في البحث`;
            if (pb) pb.disabled = currentPage <= 1;
            if (nb) nb.disabled = currentPage >= totalPages || totalPages === 0;
        }

        function changePage(delta) {
            currentPage += delta;
            renderHadiths();
        }

        function searchHadith(q) {
            if (!q || q.length < 2) {
                filteredData = currentData;
            } else {
                const query = typeof normalizeArabic === 'function' ? normalizeArabic(q) : q.toLowerCase();
                filteredData = currentData.filter(h => {
                    const t = h.text || '';
                    const normText = typeof normalizeArabic === 'function' ? normalizeArabic(t) : t.toLowerCase();
                    return normText.includes(query);
                });
            }
            currentPage = 1;
            renderHadiths();
        }

        // Bookmark Utils
        function getHadithBookmarks() {
            try { return JSON.parse(localStorage.getItem('ramadan_bookmarks') || '[]'); } catch(e) { return []; }
        }

        function isHadithBookmarked(coll, num) {
            return getHadithBookmarks().some(b => b.type === 'hadith' && b.collection === coll && String(b.id) === String(num));
        }

        function toggleHadithBookmark(coll, num, text) {
            let bookmarks = getHadithBookmarks();
            const index = bookmarks.findIndex(b => b.type === 'hadith' && b.collection === coll && String(b.id) === String(num));
            const btn = document.getElementById(`bm-hadith-${coll}-${num}`);
            const icon = btn ? btn.querySelector('i') : null;

            if (index > -1) {
                bookmarks.splice(index, 1);
                if (icon) icon.className = 'far fa-heart text-lg';
            } else {
                bookmarks.push({ 
                    type: 'hadith', collection: coll, id: num, 
                    collectionName: coll === 'bukhari' ? 'صحيح البخاري' : 'صحيح مسلم', 
                    text: text 
                });
                if (icon) icon.className = 'fas fa-heart text-lg text-red-500 scale-110';
            }
            localStorage.setItem('ramadan_bookmarks', JSON.stringify(bookmarks));
        }
    </script>
    <div id="global-player"></div>
    <style>
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .text-shadow { text-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
    </style>
</body>

</html>
